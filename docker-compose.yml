services:
  mcu-layout:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcu-layout
    restart: unless-stopped
    ports:
      - "3000:3000"
    # Настройка DNS для разрешения внешних доменов
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    # Альтернативно: используйте DNS хоста
    # dns:
    #   - 127.0.0.11  # Docker's internal DNS
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Переменные окружения из .env файла (значения по умолчанию для предотвращения предупреждений)
      - API_URL=${API_URL:-}
      - WS_HOST=${WS_HOST:-}
      - NEXT_PUBLIC_WS_HOST=${NEXT_PUBLIC_WS_HOST:-}
      # TURN сервер настройки (опционально)
      - NEXT_PUBLIC_TURN_SERVER=${NEXT_PUBLIC_TURN_SERVER:-turn:coturn:3478}
      - NEXT_PUBLIC_TURN_USERNAME=${NEXT_PUBLIC_TURN_USERNAME:-turnuser}
      - NEXT_PUBLIC_TURN_PASSWORD=${NEXT_PUBLIC_TURN_PASSWORD:-turnpassword}
      - NEXT_PUBLIC_WEBRTC_ICE_POLICY=${NEXT_PUBLIC_WEBRTC_ICE_POLICY:-all}
    env_file:
      - .env.production
    networks:
      - mcu-network
    # Временно отключаем зависимость от coturn для диагностики
    # depends_on:
    #   - coturn
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Ограничения ресурсов
    # Примечание: Если на сервере меньше ресурсов, закомментируйте или уменьшите эти значения
    deploy:
      resources:
        limits:
          # Используем 1 CPU или меньше, если доступно меньше
          cpus: '1'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

  coturn:
    image: coturn/coturn:latest
    container_name: mcu-layout-coturn
    restart: unless-stopped
    stop_grace_period: 10s
    stop_signal: SIGTERM
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "49152-65535:49152-65535/udp"
    environment:
      - TURN_USERNAME=${TURN_USERNAME:-turnuser}
      - TURN_PASSWORD=${TURN_PASSWORD:-turnpassword}
      - EXTERNAL_IP=${EXTERNAL_IP:-}
      - REALM=${TURN_REALM:-localhost}
    volumes:
      - ./coturn.conf:/etc/turnserver.conf:ro
    networks:
      - mcu-network
    # Используем entrypoint скрипт для динамического добавления --external-ip
    # Важно: используем exec чтобы turnserver стал основным процессом (PID 1)
    # Это необходимо для корректной обработки SIGTERM сигналов
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        EXTERNAL_IP_ARG=""
        if [ -n "$$EXTERNAL_IP" ]; then
          EXTERNAL_IP_ARG="--external-ip=$$EXTERNAL_IP"
        fi
        # Используем exec чтобы turnserver стал PID 1 и правильно обрабатывал сигналы
        # Флаг -n (no daemon) обязателен для foreground режима
        exec turnserver -n \
          --log-file=stdout \
          --listening-ip=0.0.0.0 \
          --listening-port=3478 \
          --min-port=49152 \
          --max-port=65535 \
          --fingerprint \
          --lt-cred-mech \
          --user=$${TURN_USERNAME:-turnuser}:$${TURN_PASSWORD:-turnpassword} \
          --realm=$${TURN_REALM:-localhost} \
          $$EXTERNAL_IP_ARG \
          --no-cli \
          --no-tls \
          --no-dtls \
          --no-multicast-peers
    # Временно отключаем healthcheck для coturn, чтобы контейнер мог запуститься
    # healthcheck:
    #   test: ["CMD-SHELL", "ps aux | grep -q '[t]urnserver' || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 30s
    init: true

networks:
  mcu-network:
    driver: bridge
    # Настройка DNS для сети (опционально)
    # driver_opts:
    #   com.docker.network.driver.mtu: 1500

